<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>App 电量优化 | CalmCenter</title><meta name="keywords" content="Android"><meta name="author" content="CalmCenter"><meta name="copyright" content="CalmCenter"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="曾经有一句笑话说的是“用 Android 手机的男人一定是个好男人，因为他每天必须回家充电，有时候还得 1 天 2 次”。">
<meta property="og:type" content="article">
<meta property="og:title" content="App 电量优化">
<meta property="og:url" content="https://calmcenter.club/2020/power-optimization.html">
<meta property="og:site_name" content="CalmCenter">
<meta property="og:description" content="曾经有一句笑话说的是“用 Android 手机的男人一定是个好男人，因为他每天必须回家充电，有时候还得 1 天 2 次”。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/CalmCenter/Pic/raw/master/cover13.webp">
<meta property="article:published_time" content="2020-05-10T04:59:00.000Z">
<meta property="article:modified_time" content="2020-05-10T04:59:00.000Z">
<meta property="article:author" content="CalmCenter">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="性能优化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/CalmCenter/Pic/raw/master/cover13.webp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://calmcenter.club/2020/power-optimization"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-right"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-05-10 12:59:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://gitee.com/CalmCenter/Pic/raw/master/cover13.webp)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">CalmCenter</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">App 电量优化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-05-10T04:59:00.000Z" title="发表于 2020-05-10 12:59:00">2020-05-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-05-10T04:59:00.000Z" title="更新于 2020-05-10 12:59:00">2020-05-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>10分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>耗电优化究竟需要做哪些工作？我们如何快速定位代码中的不合理调用，并且持续监控应用的耗电情况呢？</p>
<h1 id="本文主要记载"><a href="#本文主要记载" class="headerlink" title="本文主要记载"></a>本文主要记载</h1><ul>
<li><strong>1 优化哪些耗电行为？</strong></li>
<li><strong>2 耗电优化的难点以及方法</strong></li>
<li><strong>3 耗电监控</strong><ul>
<li>3.1 耗电监控都监控什么</li>
<li>3.2 Battery Historian</li>
<li>3.3 Android Vitals</li>
<li>3.4 Java Hook</li>
<li>3.5 插桩</li>
</ul>
</li>
<li>4 耗电量计算原理</li>
</ul>
<hr>
<h1 id="1-优化哪些耗电行为？"><a href="#1-优化哪些耗电行为？" class="headerlink" title="1 优化哪些耗电行为？"></a>1 优化哪些耗电行为？</h1><p>所谓的耗电优化不就是减少应用的耗电，增加用户的续航时间吗？但是落到实践中，如果应用需要播放视频、需要获取 <code>GPS</code> 信息、需要拍照，这些耗电看起来是无法避免的。</p>
<p>假设这个时候发现某个应用他根本没怎么使用（前台时间很少），但是耗电却非常多。这种情况会跟用户的预期差别很大，他可能就会想去投诉。</p>
<ul>
<li><p><strong>所以耗电优化的第一个方向是优化应用的后台耗电。</strong> 知道了系统是如何计算耗电的，那反过来看，我们也就可以知道应用在后台不应该做什么，例如长时间获取 <code>WakeLock</code>、<code>WiFi</code> 和蓝牙的扫描等。为什么说耗电优化第一个方向就是优化应用后台耗电，因为大部分厂商预装项目要求最严格的正是应用后台待机耗电。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/b01e359b45d22bd80efda51eee2f5f2b.png" alt="图片来源于 Android 开发高手课"></p>
</li>
<li><p><strong>耗电优化的第二个方向是符合系统的规则，让系统认为你耗电是正常的。</strong>而 <code>Android P</code> 是通过 <code>Android Vitals</code> 监控后台耗电，所以我们需要符合 <code>Android Vitals</code> 的规则，目前它的具体规则如下：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/620748a58e45e50fdea1098f15c77d15.png" alt="图片来源于 Android 开发高手课"></p>
<p>虽然上面的标准可能随时会改变，但是可以看到，<code>Android</code> 系统目前比较关心后台 <code>Alarm</code> 唤醒、后台网络、后台 <code>WiFi</code> 扫描以及部分长时间 <code>WakeLock</code> 阻止系统后台休眠。</p>
</li>
</ul>
<h1 id="2-耗电优化的难点以及方法"><a href="#2-耗电优化的难点以及方法" class="headerlink" title="2 耗电优化的难点以及方法"></a>2 耗电优化的难点以及方法</h1><p><strong>难点：</strong></p>
<ul>
<li><strong>缺乏现场，无法复现。</strong></li>
<li><strong>信息不全，难以定位。</strong></li>
<li><strong>无法评估结果。</strong>从 <code>Android 4.4</code> 开始，我们无法拿到应用的耗电信息。尽管我们解决了某个耗电问题，也很难去评估它是否已经生效，以及对用户产生的价值有多大。</li>
</ul>
<p><strong>耗电优化的方法和思路：</strong></p>
<ul>
<li><p><strong>代码的 Bug。</strong>因为某些逻辑考虑不周，可能导致 <code>GPS</code> 没有关闭、<code>WakeLock</code> 没有释放。</p>
</li>
<li><p><strong>找到需求场景的替代方案。</strong></p>
<ul>
<li>最普遍的场景就是推送，为了实现推送我们只能做各种各样的保活。在需求面前，用户的价值可能被排到第二位。我们是否可以更多地利用厂商通道，或者定时的拉取最新消息这种模式。如果真是迫不得已，是不是可以使用 <code>foreground service</code> 或者引导用户加入白名单。后台任务的总体指导思想是减少、延迟和合并，可以参考微信一个小伙写的<a target="_blank" rel="noopener" href="https://blog.dreamtobe.cn/2016/08/15/android_scheduler_and_battery/">《Android 后台调度任务与省电》</a>。</li>
</ul>
</li>
<li><p><strong>符合 Android 规则。</strong>首先系统的大部分耗电监控，都是在手机在没有充电的时候。我们可以选择在用户充电时才去做一些耗电的工作，具体方法可查看官方文档 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/monitoring-device-state/battery-monitoring">监控电池电量和充电状态</a>  。其次是尽早适配最新的 <code>Target API</code>，因为高版本系统后台限制本来就非常严格，应用在后台耗电本身就变得比较困难了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IntentFilter ifilter = <span class="keyword">new</span> IntentFilter(Intent.ACTION_BATTERY_CHANGED);</span><br><span class="line">Intent batteryStatus = context.registerReceiver(<span class="keyword">null</span>, ifilter);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取用户是否在充电的状态或者已经充满电了</span></span><br><span class="line"><span class="keyword">int</span> status = batteryStatus.getIntExtra(BatteryManager.EXTRA_STATUS, -<span class="number">1</span>);</span><br><span class="line"><span class="keyword">boolean</span> isCharging = status == BatteryManager.BATTERY_STATUS_CHARGING || status == BatteryManager.BATTERY_STATUS_FULL;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>异常情况监控。</strong>即使是最严格的 <code>Android P</code> <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/APhUH7MBDUZ6tQv0xDgaWQ">Android P 电量管理</a> ，系统也会允许应用部分地使用后台网络、<code>Alarm</code> 以及 <code>JobSheduler</code> 事件（<a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/performance/power/power-details">不同的分组，限制次数不同</a>）。因此出现异常情况的可能性还是存在的，更不用说低版本的系统。对于异常的情况，我们需要类似 <code>Android Vitals</code> 电量监控一样，将规则抽象出来，并且增加上更多辅助我们定位问题的信息。</p>
</li>
</ul>
<h1 id="3-耗电监控"><a href="#3-耗电监控" class="headerlink" title="3 耗电监控"></a>3 耗电监控</h1><h2 id="3-1-耗电监控都监控什么"><a href="#3-1-耗电监控都监控什么" class="headerlink" title="3.1 耗电监控都监控什么"></a>3.1 耗电监控都监控什么</h2><ul>
<li><strong>监控信息。</strong> 简单来说系统关心什么，我们就监控什么，而且应该以<strong>后台耗电监控为主</strong>。类似 <code>Alarm wakeup</code>、<code>WakeLock</code>、<code>WiFi scans</code>、<code>Network</code> 都是必须的，其他的可以根据应用的实际情况。如果是地图应用，后台获取 <code>GPS</code> 是被允许的；如果是计步器应用，后台获取 <code>Sensor</code> 也没有太大问题。</li>
<li><strong>现场信息。</strong> 监控系统希望可以获得完整的堆栈信息，比如哪一行代码发起了 <code>WiFi scans</code>、哪一行代码申请了 <code>WakeLock</code> 等。还有当时手机是否在充电、手机的电量水平、应用前台和后台时间、<code>CPU</code> 状态等一些信息也可以帮助我们排查某些问题。</li>
<li><strong>提炼规则。</strong> 最后我们需要将监控的内容抽象成规则，当然不同应用监控的事项或者参数都不太一样。</li>
</ul>
<p>简单规则：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/d48b7e4d3fdceb101fa7716b5892b0be.png" alt="图片来源于 Android 开发高手课"></p>
<p>在安卓绿色联盟的会议中，华为公开过他们后台资源使用的 “红线” </p>
<p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/86a65ea0d9216a11a341d7224fce93ff.png" alt="图片来源于 Android 开发高手课"></p>
<h2 id="3-2-Battery-Historian"><a href="#3-2-Battery-Historian" class="headerlink" title="3.2 Battery Historian"></a>3.2 Battery Historian</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0fa57924f228">Battery Historian 的使用与安装</a>  </p>
<p><a target="_blank" rel="noopener" href="https://github.com/google/battery-historian">Battery Historian</a> 是 <code>Android5.0</code> 之后 <code>Google</code> 开源的一款用于检测与电池有关的信息和事件的工具，从设备中收集电池数据，然后使用 <code>Battery Historian</code> 可以可视化分析相关指标如耗电比例、<code>Wifi</code>、蜂窝数据量、<code>WakeLock</code> 唤醒次数。随着 <code>Android 6.0</code> 更新了 <code>Battery Historian 2.0</code> 加入引起手机状态变化的应用。</p>
<p>通过 <code>Battery Historian</code> 可以方便的看到各耗电模块随着时间的耗电情况：包含操作类型、执行时间、对应 <code>App</code> 等；还可以进行筛选特定的 <code>App</code> ，给出一个总结性的说明，包括：<code>Network Information</code>、 <code>Syncs</code>、<code>WakeLock</code>、<code>Services</code>、<code>Process info</code>、<code>Scheduled Job</code>、<code>Sensor Use</code> 等，查看每一个模块的总结，可以看出来每一项的耗时以及执行次数。当发现异常的时候可以针对性的进行排查。</p>
<h2 id="3-3-Android-Vitals"><a href="#3-3-Android-Vitals" class="headerlink" title="3.3 Android Vitals"></a>3.3 Android Vitals</h2><p><code>Android Vitals</code> 的几个关于电量的监控方案与规则</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/performance/vitals/wakeup">Alarm Manager wakeup 唤醒过多频繁</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/performance/vitals/wakelock">使用局部唤醒锁</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/performance/vitals/bg-network-usage">后台网络使用量过高</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/performance/vitals/bg-wifi">后台 WiFi scans 过多</a></p>
<p><code>Android Vitals</code> 跟 <code>Battery Historian</code> 一样，我们只能拿到 <code>wakeup</code> 的标记的组件，拿不到申请的堆栈，也拿不到当时手机是否在充电、剩余电量等信息。</p>
<p>对于网络、<code>WiFi scans</code> 以及 <code>WakeLock</code> 也是如此。虽然 <code>Vitals</code> 帮助我们缩小了排查的范围，但是依然需要在茫茫的代码中寻找对应的可疑代码。</p>
<h2 id="3-4-Java-Hook"><a href="#3-4-Java-Hook" class="headerlink" title="3.4 Java Hook"></a>3.4 Java Hook</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/scheduling/wakelock">WakeLock</a> 。<code>WakeLock</code> 用来阻止 <code>CPU</code>、屏幕甚至是键盘的休眠。类似 <code>Alarm</code>、<code>JobService</code> 也会申请 <code>WakeLock</code> 来完成后台 <code>CPU</code> 操作。<code>WakeLock</code> 的核心控制代码都在 <a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/power/PowerManagerService.java">PowerManagerService</a> 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代理PowerManagerService</span></span><br><span class="line">ProxyHook().proxyHook(context.getSystemService(Context.POWER_SERVICE), <span class="string">&quot;mService&quot;</span>, <span class="keyword">this</span>)；</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeInvoke</span><span class="params">(Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 申请Wakelock</span></span><br><span class="line">    <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;acquireWakeLock&quot;</span>)) &#123;</span><br><span class="line">    		<span class="comment">//获取应用堆栈等等 </span></span><br><span class="line">        <span class="keyword">if</span> (isAppForeground()) &#123;</span><br><span class="line">            <span class="comment">// 应用前台逻辑，上面的规则    </span></span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 应用后台逻辑，上面的规则</span></span><br><span class="line">         &#125;</span><br><span class="line">    <span class="comment">// 释放Wakelock</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;releaseWakeLock&quot;</span>)) &#123;</span><br><span class="line">       <span class="comment">// 释放的逻辑    </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/scheduling/alarms">Alarm</a> 。<code>Alarm</code> 用来做一些定时的重复任务，它一共有四个类型，其中 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/app/AlarmManager.html#RTC_WAKEUP">ELAPSED_REALTIME_WAKEUP</a> 和 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/app/AlarmManager.html#ELAPSED_REALTIME_WAKEUP">RTC_WAKEUP</a> 类型都会唤醒设备。同样，<code>Alarm</code> 的核心控制逻辑都在 <a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/AlarmManagerService.java">AlarmManagerService</a> 中，实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代理AlarmManagerService</span></span><br><span class="line"><span class="keyword">new</span> ProxyHook().proxyHook(context.getSystemService</span><br><span class="line">(Context.ALARM_SERVICE), <span class="string">&quot;mService&quot;</span>, <span class="keyword">this</span>)；</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeInvoke</span><span class="params">(Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 设置Alarm</span></span><br><span class="line">    <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;set&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 不同版本参数类型的适配，获取应用堆栈等等</span></span><br><span class="line">    <span class="comment">// 清除Alarm</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;remove&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 清除的逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/simplezhli/Chapter19">唯鹿 Chapter19</a> </p>
<p>这个 <code>Demo</code> 使用 <code>Java Hook</code> 实现 <code>Alarm</code>、<code>WakeLock</code> 与 <code>GPS</code> 的耗电监控。</p>
<p>动态代理对应的 <a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/core/java/android/os/PowerManager.java">PowerManager</a>、<a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/core/java/android/app/AlarmManager.java">AlarmManager</a>、<a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/location/java/android/location/LocationManager.java">LocationManager</a>的<code>mService</code>实现，要拦截的方法在 <a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/power/PowerManagerService.java">PowerManagerService</a>、<a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/AlarmManagerService.java">AlarmManagerService</a>、<a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/LocationManagerService.java">LocationManagerService</a> 中。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_17766199/article/details/86770948">唯鹿原文</a> </p>
<h2 id="3-5-插桩"><a href="#3-5-插桩" class="headerlink" title="3.5 插桩"></a>3.5 插桩</h2><p>在使用 <code>Hook</code> 的时候，某些规则可能不太容易找到合适的 <code>Hook</code> 点。而且在 <code>Android P</code> 之后，很多的 <code>Hook</code> 点都不支持了。</p>
<p>出于兼容性考虑，写一个基础类，然后在统一的调用接口中增加监控逻辑。以 <code>WakeLock</code> 为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WakelockMetrics</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Wakelock 申请</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(PowerManager.WakeLock wakelock)</span> </span>&#123;</span><br><span class="line">        wakeLock.acquire();</span><br><span class="line">        <span class="comment">// 在这里增加Wakelock 申请监控逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Wakelock 释放</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">(PowerManager.WakeLock wakelock, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        wakelock.release();</span><br><span class="line">        <span class="comment">// 在这里增加Wakelock 释放监控逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Facebook</code> 也有一个耗电监控的开源库 <a target="_blank" rel="noopener" href="https://github.com/facebookincubator/Battery-Metrics">Battery-Metrics</a> ，它监控的数据非常全，包括 <code>Alarm</code>、<code>WakeLock</code>、<code>Camera</code>、<code>CPU</code>、<code>Network</code> 等，而且也有收集电量充电状态、电量水平等信息。</p>
<p><code>Battery-Metrics</code> 只是提供了一系列的基础类，在实际使用中，接入者可能需要修改大量的源码。但对于一些第三方 <code>SDK</code> 或者后续增加的代码，我们可能就不太能保证可以监控到了。这些场景也就无法监控了，所以 <code>Facebook</code> 内部是使用插桩来动态替换。</p>
<p>插桩方案使用起来兼容性非常好，并且使用者也没有太大的接入成本。但是它并不是完美无缺的，对于系统的代码插桩方案是无法替换的，例如 <code>JobService</code> 申请 <code>PARTIAL_WAKE_LOCK</code> 的场景。</p>
<h1 id="4-耗电量计算原理"><a href="#4-耗电量计算原理" class="headerlink" title="4 耗电量计算原理"></a>4 耗电量计算原理</h1><p>根据物理学的知识，电能的计算公式为 <code>电能 = 电压 * 电流 * 时间</code>。对于手机来说电压一般不会改变，所以在电压恒定的前提下，只需要测量电流和时间就可以确定耗电。</p>
<p>最终不同模块的耗电情况可以通过下面的这个公式计算：<code>模块电量(mAh) = 模块电流(mA) * 模块耗时(h)</code> 模块耗时比较容易理解，但是模块电流应该怎样去获取呢？</p>
<p><code>Android</code> 系统要求不同的厂商必须在 <code>/frameworks/base/core/res/res/xml/power_profile.xml</code> 中提供组件的电源配置文件。</p>
<p><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/base/+/master/core/res/res/xml/power_profile.xml">power_profiler.xml</a> 文件定义了不同模块的电流消耗值以及该模块在一段时间内大概消耗的电量，你也可以参考 <a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/power">Android Developer</a> 文档《Android 电源配置文件》。当然电流的大小和模块的状态也有关系，例如屏幕在不同亮度时的电流肯定会不一样。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/fa38166961e917ea6a321f84d3d4d4c1.png" alt="图片来源于 Android开发高手课"></p>
<p>Android 系统的电量计算 <a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/s?defs=PowerProfile&project=frameworks">PowerProfile</a> 也是通过读取 <code>power_profile.xml</code> 的数值而已，不同的厂商具体的数值都不太一样，我们可以通过下面的方法获取：</p>
<ul>
<li>从手机中导出 <code>/system/framework/framework-res.apk</code> 文件。</li>
<li>使用反编译工具（如 <code>apktool</code>）对导出文件 <code>framework-res.apk</code> 进行反编译。</li>
<li>查看 <code>power_profile.xml</code> 文件在 <code>framework-res</code> 反编译目录路径：<code>/res/xml/power_profile.xml</code>。</li>
</ul>
<p>对于系统的电量消耗情况，我们可以通过 <code>dumpsys batterystats</code> 导出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys batterystats &gt; battery.txt</span><br><span class="line">&#x2F;&#x2F; 各个Uid的总耗电量，而且是粗略的电量计算估计。</span><br><span class="line">Estimated power use (mAh):</span><br><span class="line">    Capacity: 3450, Computed drain: 501, actual drain: 552-587</span><br><span class="line">    ...</span><br><span class="line">    Idle: 41.8</span><br><span class="line">    Uid 0: 135 ( cpu&#x3D;103 wake&#x3D;31.5 wifi&#x3D;0.346 )</span><br><span class="line">    Uid u0a208: 17.8 ( cpu&#x3D;17.7 wake&#x3D;0.00460 wifi&#x3D;0.0901 )</span><br><span class="line">    Uid u0a65: 17.5 ( cpu&#x3D;12.7 wake&#x3D;4.11 wifi&#x3D;0.436 gps&#x3D;0.309 )</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; reset电量统计</span><br><span class="line">adb shell dumpsys batterystats --reset</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/am/BatteryStatsService.java">BatteryStatsService</a> 是对外的电量统计服务，但具体的统计工作是由 <a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/BatteryStatsImpl.java">BatteryStatsImpl</a> 来完成的，而 <a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/BatteryStatsImpl.java">BatteryStatsImpl</a> 内部使用的就是 <code>PowerProfile</code>。<code>BatteryStatsImpl</code> 会为每一个应用创建一个 <code>UID</code> 实例来监控应用的系统资源使用情况。</p>
<p>电量的使用也会跟环境有关，例如在零下十度的冬天电量会消耗得更快一些，系统提供的电量测量方法只是提供一个参考的数值。不过通过上面的这个方法，我们可以成功把电量的测量转化为功能模块的使用时间或者次数。</p>
<p>准确的测量电量并不是那么容易，在<a target="_blank" rel="noopener" href="https://tech.meituan.com/2018/03/11/dianping-shortvideo-battery-testcase.html">《大众点评 App 的短视频耗电量优化实战》</a> 一文中，总结了下面几种电量测试的方法。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/ae1b52340f802f25a09c31c13a2a22fe.png" alt="图片来源于 Android开发高手课"></p>
<h1 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a><strong>感谢</strong></h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/74044">极客时间 Android开发高手课</a>  </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/aa20616012/article/details/49781875">Android 6.0新特性之Doze模式</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5d83d8649c98">Android性能优化（九）之不可忽视的电量</a> </p>
<p>以及上文中的链接</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">CalmCenter</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://calmcenter.club/2020/power-optimization.html">https://calmcenter.club/2020/power-optimization.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://calmcenter.club" target="_blank">CalmCenter</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></div><div class="post_share"><div class="social-share" data-image="https://gitee.com/CalmCenter/Pic/raw/master/cover13.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/wechat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/alipay.png" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/storage-optimization.html"><img class="prev-cover" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/cover16.webp" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">App 存储优化💦</div></div></a></div><div class="next-post pull-right"><a href="/2020/hobble-optimization.html"><img class="next-cover" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/cover25.webp" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">App 直观感受-卡顿优化🌈</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/memory-optimization.html" title="App 内存知识介绍💦"><img class="cover" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/cover35.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-28</div><div class="title">App 内存知识介绍💦</div></div></a></div><div><a href="/2019/complete-works-of-android-performance.html" title="Android 性能优化篇"><img class="cover" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/20200228233120.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-12-01</div><div class="title">Android 性能优化篇</div></div></a></div><div><a href="/2020/stability-optimization.html" title="稳定性优化"><img class="cover" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/cover26.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-02</div><div class="title">稳定性优化</div></div></a></div><div><a href="/2020/memory-optimization2.html" title="App 内存检测优化💦"><img class="cover" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/cover12.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-29</div><div class="title">App 内存检测优化💦</div></div></a></div><div><a href="/2020/hobble-optimization.html" title="App 直观感受-卡顿优化🌈"><img class="cover" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/cover25.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-20</div><div class="title">App 直观感受-卡顿优化🌈</div></div></a></div><div><a href="/2020/network-optimization.html" title="App 网络优化🌞"><img class="cover" data-lazy-src="https://gitee.com/CalmCenter/Pic/raw/master/cover19.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-20</div><div class="title">App 网络优化🌞</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">CalmCenter</div><div class="author-info__description">目标设置到月球，即使陨落也是在群星之间！</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/CalmCenter"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">不要努力成为一个成功的人，而要努力成为一个有价值的人。</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%AC%E6%96%87%E4%B8%BB%E8%A6%81%E8%AE%B0%E8%BD%BD"><span class="toc-text">本文主要记载</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E4%BC%98%E5%8C%96%E5%93%AA%E4%BA%9B%E8%80%97%E7%94%B5%E8%A1%8C%E4%B8%BA%EF%BC%9F"><span class="toc-text">1 优化哪些耗电行为？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E8%80%97%E7%94%B5%E4%BC%98%E5%8C%96%E7%9A%84%E9%9A%BE%E7%82%B9%E4%BB%A5%E5%8F%8A%E6%96%B9%E6%B3%95"><span class="toc-text">2 耗电优化的难点以及方法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E8%80%97%E7%94%B5%E7%9B%91%E6%8E%A7"><span class="toc-text">3 耗电监控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E8%80%97%E7%94%B5%E7%9B%91%E6%8E%A7%E9%83%BD%E7%9B%91%E6%8E%A7%E4%BB%80%E4%B9%88"><span class="toc-text">3.1 耗电监控都监控什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Battery-Historian"><span class="toc-text">3.2 Battery Historian</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Android-Vitals"><span class="toc-text">3.3 Android Vitals</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-Java-Hook"><span class="toc-text">3.4 Java Hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E6%8F%92%E6%A1%A9"><span class="toc-text">3.5 插桩</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E8%80%97%E7%94%B5%E9%87%8F%E8%AE%A1%E7%AE%97%E5%8E%9F%E7%90%86"><span class="toc-text">4 耗电量计算原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%84%9F%E8%B0%A2"><span class="toc-text">感谢</span></a></li></ol></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 By CalmCenter</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: '9b707b75b56f9e432b12',
      clientSecret: '6e2d5a012729aa6c9e8df3cc0a90d82f976a026e',
      repo: 'calmcenter.github.io',
      owner: 'CalmCenter',
      admin: ['CalmCenter'],
      id: '06e1f61d3f1a25c509ce5da4957721bd',
      language: 'zh-CN',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    $.getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js', initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script></div></body></html>